<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Cadastrar Funcionário</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
<div class="page">
    <div class="card card--narrow">

        <h1 id="titulo-form">Cadastrar Funcionário</h1>

        <!-- Mensagem geral -->
        <div id="mensagem"></div>

        <form id="form-funcionario">

            <div class="field">
                <label for="id">ID</label>
                <input type="number" id="id" required min="1">
                <small class="field-error" id="erro-id"></small>
            </div>

            <div class="field">
                <label for="nome">Nome</label>
                <input type="text" id="nome" required placeholder="Ex: João Silva">
                <small class="field-error" id="erro-nome"></small>
            </div>

            <div class="field">
                <label for="cpf">CPF</label>
                <input type="text" id="cpf" required maxlength="14" placeholder="000.000.000-00">
                <small class="hint">Formato esperado: 000.000.000-00</small>
                <small class="field-error" id="erro-cpf"></small>
            </div>

            <div class="field">
                <label for="idade">Idade</label>
                <input type="number" id="idade" min="16" max="100">
                <small class="field-error" id="erro-idade"></small>
            </div>

            <div class="field">
                <label for="salario">Salário</label>
                <input type="number" id="salario" required>
                <small class="field-error" id="erro-salario"></small>
            </div>

            <div class="actions">
                <button type="submit" class="btn-primary">Salvar</button>
                <button type="button" class="btn-secondary" id="btn-voltar">Voltar</button>
            </div>
        </form>
    </div>
</div>


<script>
    // ==============================================
    // BOTÃO VOLTAR
    // ==============================================
    document.getElementById("btn-voltar").onclick = () => {
        window.location.href = "index.html";
    };

    // ==============================================
    // MÁSCARA AUTOMÁTICA DE CPF
    // ==============================================
    const cpfInput = document.getElementById("cpf");
    cpfInput.addEventListener("input", (e) => {
        let v = e.target.value.replace(/\D/g, "");
        if (v.length > 11) v = v.slice(0, 11);

        if (v.length >= 10) {
            e.target.value = v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
        } else if (v.length >= 7) {
            e.target.value = v.replace(/(\d{3})(\d{3})(\d{1,3})/, "$1.$2.$3");
        } else if (v.length >= 4) {
            e.target.value = v.replace(/(\d{3})(\d{1,3})/, "$1.$2");
        } else {
            e.target.value = v;
        }
    });

    // ==============================================
    // MODO EDITAR (se tiver ?id=)
    // ==============================================
    const params = new URLSearchParams(window.location.search);
    const editId = params.get("id");
    const titulo = document.getElementById("titulo-form");
    const msgDiv = document.getElementById("mensagem");

    if (editId) {
        titulo.textContent = "Editar Funcionário";
        carregarDados(editId);
    }

    async function carregarDados(id) {
        try {
            const resp = await fetch(`/funcionarios/${id}`);
            if (!resp.ok) return;

            const f = await resp.json();

            idInput.value = f.id;
            nome.value = f.nome;
            cpf.value = f.cpf;
            idade.value = f.idade ?? "";
            salario.value = f.salario;

        } catch (e) {
            console.error(e);
        }
    }

    // ==============================================
    // SUBMISSÃO DO FORMULÁRIO
    // ==============================================
    const form = document.getElementById("form-funcionario");
    const idInput = document.getElementById("id");

    form.addEventListener("submit", async function (e) {
        e.preventDefault();

        // limpar mensagens antigas
        msgDiv.textContent = "";
        msgDiv.className = "";

        document.querySelectorAll(".field-error").forEach(el => el.textContent = "");

        const payload = {
            id: Number(idInput.value),
            nome: nome.value,
            cpf: cpf.value,
            idade: idade.value ? Number(idade.value) : null,
            salario: Number(salario.value)
        };

        const method = editId ? "PUT" : "POST";
        const url = editId ? `/funcionarios/${editId}` : "/funcionarios";

        try {
            const resp = await fetch(url, {
                method: method,
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(payload)
            });

            if (resp.ok) {
                msgDiv.textContent = editId ? "Funcionário atualizado!" : "Funcionário cadastrado!";
                msgDiv.classList.add("ok");
                setTimeout(() => (window.location.href = "index.html"), 900);
                return;
            }

            const raw = await resp.text();
            tratarErros(raw);

        } catch (error) {
            console.error(error);
            msgDiv.textContent = "Erro ao conectar ao servidor.";
            msgDiv.classList.add("erro");
        }
    });

    // ==============================================
    // TRATAR ERROS DO BACKEND (versão inteligente)
    // ==============================================
    function tratarErros(raw) {
        let msg = raw;

        // tenta decodificar JSON se vier em formato JSON
        try {
            const json = JSON.parse(raw);

            if (json.message) msg = json.message;
            else if (json.error) msg = json.error;
        } catch {
            msg = raw;
        }

        // fallback do Spring Boot (errozão HTML/JSON gigante)
        if (msg.length > 120) {
            msg = "Erro na requisição. Verifique os dados.";
        }

        // erros específicos por campo
        const mapa = [
            ["CPF", "cpf"],
            ["Nome", "nome"],
            ["Salári", "salario"],
            ["Idade", "idade"],
            ["ID", "id"]
        ];

        for (const [texto, campo] of mapa) {
            if (msg.includes(texto)) {
                document.getElementById(`erro-${campo}`).textContent = msg;
                return;
            }
        }

        // erro genérico
        msgDiv.textContent = msg;
        msgDiv.classList.add("erro");
    }
</script>

</body>
</html>
