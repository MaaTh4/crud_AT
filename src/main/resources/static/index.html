<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Funcionários</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
<div class="page">
    <div class="card">

        <div class="header">
            <h1>Funcionários</h1>
            <button class="btn-primary" id="btn-novo">+ Novo Funcionário</button>
        </div>

        <div id="mensagem"></div>

        <table>
            <thead>
            <tr>
                <th>ID</th>
                <th>Nome</th>
                <th>CPF</th>
                <th>Idade</th>
                <th>Salário</th>
                <th>Ações</th>
            </tr>
            </thead>
            <tbody id="tabela-corpo">
            <tr><td colspan="6" class="empty">Carregando...</td></tr>
            </tbody>
        </table>

    </div>
</div>

<script>
    const tbody = document.getElementById('tabela-corpo');
    const msgDiv = document.getElementById('mensagem');
    const btnNovo = document.getElementById('btn-novo');

    btnNovo.addEventListener('click', () => {
        window.location.href = 'form.html';
    });

    async function carregar() {
        msgDiv.textContent = "";
        try {
            const resp = await fetch('/funcionarios');
            if (!resp.ok) {
                msgDiv.textContent = "Erro ao carregar funcionários.";
                msgDiv.classList.add("erro");
                return;
            }

            const data = await resp.json();

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty">Nenhum funcionário cadastrado.</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            data.forEach(f => {
                const tr = document.createElement('tr');

                tr.innerHTML = `
                    <td>${f.id}</td>
                    <td>${f.nome}</td>
                    <td>${f.cpf}</td>
                    <td>${f.idade ?? ""}</td>
                    <td>R$ ${Number(f.salario).toFixed(2)}</td>
                    <td>
                        <button class="btn-edit" onclick="editarFuncionario(${f.id})">Editar</button>
                        <button class="btn-danger" onclick="excluirFuncionario(${f.id})">Excluir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

        } catch (err) {
            console.error(err);
            msgDiv.textContent = "Erro ao conectar ao servidor.";
            msgDiv.classList.add("erro");
        }
    }

    function editarFuncionario(id) {
        window.location.href = `form.html?id=${id}`;
    }

    async function excluirFuncionario(id) {
        if (!confirm(`Excluir funcionário ID ${id}?`)) return;

        try {
            const resp = await fetch(`/funcionarios/${id}`, { method: "DELETE" });

            if (resp.ok) {
                msgDiv.textContent = "Funcionário excluído com sucesso!";
                msgDiv.classList.add("ok");
                carregar();
            } else {
                const txt = await resp.text();
                msgDiv.textContent = txt;
                msgDiv.classList.add("erro");
            }

        } catch (e) {
            msgDiv.textContent = "Erro ao excluir.";
            msgDiv.classList.add("erro");
        }
    }

    carregar();
</script>

</body>
</html>
